name: auto test on pull request ready
on:
  pull_request:
    types:
      - opened
      - ready_for_review
      - reopened
jobs:
  auto-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: checkout repository
        uses: actions/checkout@v4
      - name: set up docker buildx
        uses: docker/setup-buildx-action@v3
      - name: cache docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('environment/testing/Dockerfile', 'package.json', 'pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      - name: copy config files for testing
        run: |
          cp .envtest .env
          cp config/accountstest.json config/accounts.json
          cp config/configtest.json config/config.json
          cp config/databasetest.json config/database.json
          cp config/roletest.json config/role.json

      - name: build docker image with cache
        uses: docker/build-push-action@v6
        with:
          context: .
          file: environment/testing/Dockerfile
          load: true
          tags: waiwaichan-testing:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: docker compose up
        run: |
          docker compose \
            -f environment/testing/docker-compose.yml \
            up -d --wait

      - name: run pnpm test into backend container
        run: |
          docker compose \
            -f environment/testing/docker-compose.yml \
            exec -T backend pnpm test
      - name: show logs on failure
        if: failure()
        run: |
          echo "=== All container logs ==="
          docker compose \
            -f environment/testing/docker-compose.yml \
            logs --no-color
          echo "=== Migrate container logs ==="
          docker compose \
            -f environment/testing/docker-compose.yml \
            logs migrate --no-color 2>&1 || true
      - name: docker compose down
        if: always()
        run: |
          docker compose \
            -f environment/testing/docker-compose.yml \
            down -v

name: pnpm test on pull request ready
on:
  pull_request:
    types:
      - opened
      - ready_for_review
      - reopened
jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: checkout repository
        uses: actions/checkout@v4
      - name: set up docker buildx
        uses: docker/setup-buildx-action@v3
      - name: rename config files for testing
        run: |
          mv .envtest .env
          mv config/accountstest.json config/account.json
          mv config/configtest.json config/config.json
          mv config/databasetest.json config/database.json
          mv config/roletest.json config/role.json
      - name: docker compose up
        run: |
          docker compose \
            -f environment/testing/docker-compose.yml \
            up -d
      - name: run pnpm test into backend container
        run: |
          docker compose \
            -f environment/testing/docker-compose.yml \
            exec -T backend pnpm test
      - name: show logs on failure
        if: failure()
        run: |
          echo "=== All container logs ==="
          docker compose \
            -f environment/testing/docker-compose.yml \
            logs --no-color
          echo "=== Migrate container logs ==="
          docker logs waiwai-migrate 2>&1 || true
      - name: docker compose down
        if: always()
        run: |
          docker compose \
            -f environment/testing/docker-compose.yml \
            down -v

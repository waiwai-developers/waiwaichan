services:
  backend:
    container_name: waiwai-backend
    restart: always
    tty: true
    image: asia-northeast1-docker.pkg.dev/waiwai-406106/waiwaichan/image:latest
    volumes:
      - type: bind
        source: ../../.
        target: /app
      - type: volume
        source: backend_node_modules
        target: /app/node_modules
    networks:
      - server-network
    environment:
      GOOGLE_APPLICATION_CREDENTIALS: config/key.json
    command: sh -c "npm i && pnpm run dev"
  scheduler:
    container_name: waiwai-scheduler
    restart: "always"
    image: asia-northeast1-docker.pkg.dev/waiwai-406106/waiwaichan/image:latest
    volumes:
      - type: bind
        source: ../../.
        target: /app
      - type: volume
        source: scheduler_node_modules
        target: /app/node_modules
    networks:
      - server-network
    command: sh -c "npm i && pnpm run dev:scheduler"
  migrate:
    container_name: waiwai-migrate
    restart: "no"
    image: asia-northeast1-docker.pkg.dev/waiwai-406106/waiwaichan/image:latest
    volumes:
      - type: bind
        source: ../../.
        target: /app
      - type: volume
        source: migrate_node_modules
        target: /app/node_modules
    networks:
      - server-network
    command: sh -c "npm i && pnpm run migrate up && pnpm run seed up"
networks:
  server-network:
    driver: bridge
volumes:
  backend_node_modules:
  scheduler_node_modules:
  migrate_node_modules:
